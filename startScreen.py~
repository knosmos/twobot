import sys, os, random
import runLevel
from panda3d.core import *

loadPrcFileData('Change Window Title','window-title Twobot')
loadPrcFileData('Set Window Icon','icon-filename ui/icon.ico')

props = WindowProperties( )
props.setIconFilename( 'ui/icon.ico' )
base.win.requestProperties( props )

import direct.directbase.DirectStart

from direct.gui.OnscreenText import OnscreenText
from direct.gui.OnscreenImage import OnscreenImage
from direct.gui.DirectGui import *

font = loader.loadFont('ui/Helpimtrappedinafont.ttf')
font.setPixelsPerUnit(200)
font.setPageSize(512,512)
font.setNativeAntialias(True)

# Transitions
from direct.showbase.Transitions import Transitions
transition = Transitions(loader)

# The two nodes, which contain the "start" and "select" screens
start = aspect2d.attachNewNode('start')
select = aspect2d.attachNewNode('select')

# A function to convert normal rgb into Panda rgb
def rgb(r,g,b,a=1):
    return (r/255.0,g/255.0,b/255.0,a)

def loadStart():
    print('Loading start screen')
    select.detachNode()
    start.reparentTo(aspect2d)

def loadSelect():
    print('Loading level select')
    start.detachNode()
    select.reparentTo(aspect2d)

def loadSettings():
    print('TODO')

def loadQuit():
    print('Quitting Twobot')
    sys.exit()

# Creates title
def largeText(text,y):
    return OnscreenText(
            text=text,
            font=font,
            scale=0.5,
            fg=(1,1,1,1),
            align=TextNode.ALeft,
            pos=(-1.1,0,y)
        )

# Simple text-only button
def button(text,y,command,x=-1):
    return DirectButton(
        text=text,
        text_font=font,
        text_align=TextNode.ALeft,
        pos=(x,0,y),
        scale=0.2,
        text_fg=(1,1,1,1),
        frameColor=(1,1,1,0),
        command=command
    )

# Level Button.
def levelButton(filename,status,height):
    # Generates a button with different backgrounds depending on status.
    # Also starts the level when clicked.
    number = int(filename.split('_')[0])
    name = ' '.join(filename.split('_')[1:]).split('.')[0]
    backgroundColor = [
        rgb(100,255,100,0.5),
        rgb(255,255,255,0.5),
        rgb(0,0,0,0.5)
    ][status] # 0 = completed, 1 = available, 2 = locked
    return DirectButton(
        text=name,
        text_font=font,
        #text_align=TextNode.ALeft,
        pos=(0,0,height-number*0.3),
        frameSize=(-1.1,1.1,0.7,-0.3),
        frameColor=backgroundColor,
        scale=0.2,
        relief=6,
        command=startLevel,
        extraArgs=['levels/'+filename],
        suppressMouse=False
    )

# Creates a background image, obviously
def backgroundImage(name):
    iH=PNMImageHeader()
    iH.readHeader(Filename(name))
    yS=float(iH.getYSize())
    np=OnscreenImage(name,parent=aspect2d)
    np.setScale(Vec3(iH.getXSize(),1,yS)/base.win.getXSize())
    return np

'''START'''

# Background Image
image = backgroundImage('ui/startScreenDark.png')
image.reparentTo(start)

# Title
title = largeText('twobot',1)
title.reparentTo(start)

# Buttons
startButton = button('start game>',-0.25,loadSelect)
settingsButton = button('settings>',-0.40,loadSettings)
endButton = button('quit>',-0.55,loadQuit)

startButton.reparentTo(start)
settingsButton.reparentTo(start)
endButton.reparentTo(start)

'''RUNLEVEL'''

def detectWin(task):
    # Detects when the "win" variable is True, plays a darken animation and calls cleanupLevel.
    if runLevel.win:
        print('Level complete')
        transition.fadeOut(t=1)
        taskMgr.doMethodLater(1,cleanupLevel,'cleanupLevel')
        return
    return task.cont

def cleanupLevel(task=None):
    # Clears the level and loads the select screen
    # The unused "task" variable is because this function may be fired by taskMgr.
    transition.noFade()
    runLevel.clearLevel()
    select.reparentTo(aspect2d)

def startLevel(name):
    print('Starting level',name)
    select.detachNode()
    runLevel.level = runLevel.makeLevel(name)
    runLevel.win = False
    taskMgr.add(runLevel.run,'run')
    taskMgr.add(detectWin,'detectWin')

'''SELECT'''

# Get all available level names
levelFileNames = os.listdir('levels')

# Background Image
image = backgroundImage('ui/levelSelectScreen.png')
image.reparentTo(select)

# Back button
backButton = button('<back',0.8,loadStart,x=-1.3)
backButton.reparentTo(select)

# Level-frame
totalHeight = len(levelFileNames)*0.3
levelframe = DirectScrolledFrame(
    canvasSize = (-1.2,1.2,-0.2,totalHeight),
    frameSize = (-1.2,1.2,-0.2,1.5),
    frameColor = (0,0,0,0.1),
    scrollBarWidth = 0
)

levelframe.setPos(0,0,-0.75)
levelframe.reparentTo(select)

# Manually scrolls the frame by movements of the scroll wheel.
def scroll(amount):
    levelframe.verticalScroll['value'] += amount

base.accept('wheel_up',scroll,[-0.2])
base.accept('wheel_down',scroll,[0.2])

# Levels
for i in levelFileNames:
    b = levelButton(i,0,totalHeight)
    b.reparentTo(levelframe.getCanvas())

start.detachNode()
select.detachNode()

if __name__ == '__main__':
    loadStart()
    base.run()
